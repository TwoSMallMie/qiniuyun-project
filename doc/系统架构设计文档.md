# 历史人物AI聊天系统架构设计文档

## 项目概述

这是一个基于Vue.js + Node.js + MySQL的全栈历史人物AI聊天系统，用户可以与AI驱动的历史人物进行对话交流，系统还包含历史人物广场、模型管理等功能模块。

## 系统架构

### 整体架构
```
┌─────────────────────────────────────────────────────────────┐
│                    前端 (Vue.js 2.x)                        │
├─────────────────────────────────────────────────────────────┤
│                    后端 (Node.js + Express)                 │
├─────────────────────────────────────────────────────────────┤
│                    数据库 (MySQL)                           │
└─────────────────────────────────────────────────────────────┘
```

### 技术栈
- **前端**: Vue.js 2.6.14 + Vue Router + Vuex + Element UI
- **后端**: Node.js + Express.js
- **数据库**: MySQL
- **实时通信**: WebSocket
- **AI服务**: 集成OpenAI API的七牛云api
- **语音识别**: 七牛云ASR

## 前端架构 (client/)

### 项目结构
```
client/
├── public/                    # 静态资源
├── src/
│   ├── assets/               # 资源文件
│   │   ├── imgs/            # 图片资源
│   │   └── logo.png
│   ├── components/          # 可复用组件
│   │   ├── ChatDialog/      # 聊天对话框组件
│   │   ├── ModelDropdown.vue # 模型选择下拉框
│   │   ├── MultiLineInput/  # 多行输入组件
│   │   └── sideBarNav.vue   # 侧边导航组件
│   ├── router/              # 路由配置
│   ├── store/               # 状态管理
│   │   ├── index.js         # 主store
│   │   └── modules/         # 模块化管理
│   ├── utils/               # 工具函数
│   │   ├── copyToClipboard/ # 剪贴板操作
│   │   ├── helper/          # 辅助函数
│   │   └── request/         # HTTP请求封装
│   ├── views/               # 页面组件
│   │   ├── HistoricalFiguresMarket/ # 历史人物广场
│   │   ├── chatView/        # 聊天界面
│   │   └── test.vue         # 测试页面
│   ├── App.vue              # 根组件
│   └── main.js              # 入口文件
├── package.json
└── vue.config.js            # Vue配置
```

### 核心功能模块

#### 1. 状态管理 (Vuex)
#### 2. 页面组件
#### 3. 功能组件

### 前端特色功能
1. **响应式布局**: 适配不同屏幕尺寸
2. **图片懒加载**: 优化性能体验
3. **状态持久化**: Vuex管理应用状态
4. **组件化开发**: 高度可复用的组件设计

## 后端架构 (serve/)

### 项目结构
```
serve/
├── src/
│   ├── controller/          # 控制器层
│   │   ├── historicalFigureController.js  # 历史人物控制器
│   │   └── qiniuController.js              # 七牛云控制器
│   ├── service/             # 业务逻辑层
│   │   ├── historicalFigureService.js     # 历史人物服务
│   │   └── qiniuService.js                 # 七牛云服务
│   ├── routes/              # 路由层
│   │   ├── historicalFigureRoutes.js      # 历史人物路由
│   │   └── qiniuRoutes.js                  # 七牛云路由
│   ├── sql/                 # SQL脚本
│   │   ├── historical_figures.sql         # 历史人物表结构
│   │   ├── historical_figure_models.sql   # 模型表结构
│   │   └── init_database.sql              # 数据库初始化
│   ├── static/              # 静态资源
│   │   └── imgs/            # 人物图片
│   ├── asrWebSocketServer.js # WebSocket语音识别服务器
│   ├── db.js                 # 数据库连接配置
│   ├── index.js              # 主入口文件
│   └── qiniu.js              # 七牛云配置
├── package.json
└── test/                    # 测试文件
```

### 核心服务层设计

#### 1. 历史人物服务 (HistoricalFigureService)
采用**类静态方法**设计模式，包含三个主要服务类：

**HistoricalFigureService** - 基础人物管理
**HistoricalFigureModelService** - 模型管理
**HistoricalFigureTagService** - 标签管理

#### 2. 控制器层 (Controller)
统一处理HTTP请求，调用对应的服务层方法，返回标准化响应格式。

#### 3. 数据访问层
基于MySQL的原始查询封装，提供统一的`query()`方法。

### 特色功能

#### 1. 图片处理服务
- **本地文件读取**: 使用Node.js fs模块
- **Base64编码**: 自动转换为data URL格式
- **错误处理**: 完善的异常捕获机制

#### 2. WebSocket语音识别
- **实时音频流**: 支持16kHz采样率
- **七牛云ASR**: 集成七牛云语音识别服务
- **多客户端支持**: 支持并发连接


## 系统集成与通信

### 前后端通信
- **协议**: HTTP/HTTPS + WebSocket
- **数据格式**: JSON
- **请求封装**: Axios统一处理

### 第三方服务集成
七牛云：作为模型和语音转换的api

### 错误处理机制
- **前端**: 统一的错误提示组件
- **后端**: 全局异常捕获
- **日志记录**: 详细的请求和错误日志

## 性能优化

### 前端优化
1. **组件懒加载**: 路由级别的代码分割
2. **图片优化**: Base64编码存储，减少HTTP请求
3. **状态管理**: 合理的状态结构设计

### 后端优化
1. **数据库连接池**: 复用数据库连接
2. **静态资源缓存**: 合理的缓存策略
3. **异步处理**: 非阻塞I/O操作

## 安全设计

### 前端安全
1. **输入验证**: 表单输入校验
2. **XSS防护**: 自动转义处理
3. **CSRF防护**: 请求头验证

### 后端安全
1. **SQL注入防护**: 参数化查询
2. **数据验证**: 严格的输入验证
3. **错误信息脱敏**: 不暴露系统内部信息

## 部署架构

### 开发环境
```bash
# 前端开发
npm run serve

# 后端开发
npm start
```

### 生产环境
- **前端**: 静态文件部署到CDN
- **后端**: Node.js进程管理(PM2)
- **数据库**: MySQL主从配置

## 扩展性设计

### 水平扩展
- **无状态服务**: 后端服务无状态设计
- **数据库分片**: 支持数据库水平拆分
- **缓存层**: 支持Redis缓存接入

### 功能扩展
- **插件化架构**: 支持功能模块动态加载
- **API版本控制**: 支持API版本管理
- **多语言支持**: 国际化架构设计

---

**文档版本**: v1.0
**维护团队**: 一人成型